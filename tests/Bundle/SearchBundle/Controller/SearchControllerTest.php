<?php

namespace Tests\Bundle\SearchBundle\Tests\Controller;

use Doctrine\ODM\MongoDB\DocumentManager;
use MBH\Bundle\BaseBundle\Lib\Test\WebTestCase;

class SearchControllerTest extends WebTestCase
{

    /** @var DocumentManager */
    private $dm;

    public function setUp()
    {
        $this->dm = $this->getContainer()->get('doctrine_mongodb.odm.default_document_manager');
        parent::setUp(); // TODO: Change the autogenerated stub
    }


    public function testSearchRequest(): void
    {

        $qb = $this->dm->getRepository('MBHHotelBundle:RoomType')->createQueryBuilder();
        /** @var \Doctrine\MongoDB\ArrayIterator $ids */
        $raw = $qb->find()->getQuery()->execute()->toArray();
        $ids = array_keys($raw);

        $inputData = [
            'url' => '/search/json',
            'data' => [
                'begin' => '01.05.2018',
                'end' => '15.05.2018',
                'adults' => 3,
                'children' => 0

            ],
            'results' => [
                'search_request' => [
                    'status' => 'ok',
                    'expected_results' => 6,
                ],
            ],
        ];


        $this->client->request(
            'POST',
            $inputData['url'],
            [],
            [],
            ['CONTENT_TYPE' => 'application/json'],
            json_encode($inputData['data'])
        );

        $this->isSuccessful($this->client->getResponse());
        $content = $this->client->getResponse()->getContent();
        $this->assertJson($content, 'No JSON Returned');
        $this->assertJsonStringEqualsJsonString(json_encode($inputData['results']), $content, 'JSON Content is wrong');
    }


}
