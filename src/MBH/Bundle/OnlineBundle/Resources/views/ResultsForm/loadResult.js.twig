{#/*global window, document */#}
{% wrapinline %}
{% if constant('MBH\\Bundle\\ClientBundle\\Document\\PaymentSystem\\NewRbk::KEY') in paymentSystems %}
{% include '@MBHClient/PaymentSystem/newRbk/script_for_online_form.js.twig' %}
{% endif %}

function addLoadEvent(func) {
  var oldonload = window.onload;
  if (typeof window.onload != 'function') {
    window.onload = func;
  } else {
    window.onload = function() {
      if (oldonload) {
        oldonload();
      }
      func();
    };
  }
}

function OnLoadResultsLoad() {
    this._stepOneButton = {
        url: '{{ url.stepOneButton }}',
        height: {{ config.stepOneButtonHeight }}
    };

    this._iframeUrl = '{{ url('online_form_results_iframe', {formConfigId: config.id}) }}';
};

OnLoadResultsLoad.prototype.metrics = function() {
    {% if config.yandexAnalyticConfig.isEnabled and config.yandexAnalyticConfig.id %}
        var yaCounterId = "{{ config.yandexAnalyticConfig.id }}";
        (function () {
            var yaCounterObjName = 'yaCounter' + yaCounterId;
            {#<!-- Yandex.Metrika counter -->#}
            (function (d, w, c) {
                (w[c] = w[c] || []).push(function () {
                    try {
                        w[yaCounterObjName] = new Ya.Metrika({
                            id: yaCounterId,
                            clickmap: true,
                            trackLinks: true,
                            accurateTrackBounce: true,
                            webvisor: true
                        });
                    } catch (e) {
                    }
                });

                var n = d.getElementsByTagName("script")[0],
                    s = d.createElement("script"),
                    f = function () {
                        n.parentNode.insertBefore(s, n);
                    };
                s.type = "text/javascript";
                s.async = true;
                s.src = "https://mc.yandex.ru/metrika/watch.js";

                if (w.opera == "[object Opera]") {
                    d.addEventListener("DOMContentLoaded", f, false);
                } else {
                    f();
                }
            })(document, window, "yandex_metrika_callbacks");
            {#<!-- /Yandex.Metrika counter -->#}
        }) ();
    {% endif %}

    {% if config.googleAnalyticConfig.isEnabled and config.googleAnalyticConfig.id %}
        var googleCounterId = "{{ config.googleAnalyticConfig.id }}";
        (function() {
                (function (i, s, o, g, r, a, m) {
                    i['GoogleAnalyticsObject'] = r;
                    i[r] = i[r] || function () {
                        (i[r].q = i[r].q || []).push(arguments)
                    }, i[r].l = 1 * new Date();
                    a = s.createElement(o),
                        m = s.getElementsByTagName(o)[0];
                    a.async = 1;
                    a.src = g;
                    m.parentNode.insertBefore(a, m)
                })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

                ga('create', googleCounterId, 'auto');
                ga('send', 'pageview');
        })();
    {% endif %}

    var processMetricMessage = function (e) {
        if (e.data.type === 'form-event') {
            var purposeType = e.data.purpose;
            if (typeof yaCounterId !== 'undefined') {
                window[yaCounterObjName].reachGoal(purposeType);
            }
            if (typeof googleCounterId !== 'undefined') {
                ga('send', 'event', purposeType, 'click');
            }
        }
    };

    window.addEventListener("message", processMetricMessage, false);
};

OnLoadResultsLoad.prototype.initUrl = function () {
    var urlIndex = window.location.href.indexOf('?');
    var url = '';
    if (urlIndex !== -1) {
        url = window.location.href.slice(urlIndex);
    }
    if (this._iframeUrl.indexOf('?') > -1) {
        url = url.replace('?', '&');
    }

    this._searchParamsFromUrl = url;
};

OnLoadResultsLoad.prototype.createResultIframe = function() {
    var resultsIframe = document.createElement('iframe');
    resultsIframe.width = '100%';
    resultsIframe.id = 'mbh-results-iframe';
    resultsIframe.scrolling = 'no';
    resultsIframe.style.border = 'none';
    resultsIframe.height = '300';
    resultsIframe.src = this._iframeUrl + this._searchParamsFromUrl;

    this._resultsIframe = resultsIframe;
    this._resultsWrapper.appendChild(resultsIframe);
};

OnLoadResultsLoad.prototype.createButtonForStepOne = function () {
    var divWrapper = document.createElement('div'),
        heightButton = this._stepOneButton.height;

    divWrapper.id = 'mbh-results-step-one-button-wrapper';
    divWrapper.style.height = heightButton + 'px';
    divWrapper.style.marginBottom = '5px';
    divWrapper.style.display = 'none';

    var iframe = document.createElement('iframe');
    iframe.id = 'mbh-results-step-one-button-iframe';
    iframe.src = this._stepOneButton.url + this._searchParamsFromUrl;
    iframe.width = '100%';
    iframe.height = heightButton + 'px';
    iframe.style.border = 'none';
    iframe.style.position = 'fixed';
    iframe.style.bottom = 0;
    iframe.scrolling = 'no';

    this._stepOneButtonIframe = iframe;
    divWrapper.appendChild(iframe);

    this._stepOneButtonWrapper = divWrapper;
    this._resultsWrapper.appendChild(divWrapper);

    var _this = this;

    setInterval(function() {
        _this._stepOneButtonIframe.style.maxWidth = _this._stepOneButtonWrapper.clientWidth + 'px';
        _this._stepOneButtonWrapperCoordsY = parseInt(_this._stepOneButtonWrapper.offsetTop) - parseInt(screen.availHeight) + heightButton
    }, 1000);
};

OnLoadResultsLoad.prototype.eventToScroll = function () {
    var _this = this;

    window.addEventListener('scroll', function () {
        if (_this._resultsIframe === null || !_this._resultsIframe.contentWindow) {
            return;
        }

        if (window.pageYOffset > _this._stepOneButtonWrapperCoordsY) {
            _this._stepOneButtonIframe.style.position = 'absolute';
            _this._stepOneButtonIframe.style.bottom = '';
        } else {
            _this._stepOneButtonIframe.style.position = 'fixed';
            _this._stepOneButtonIframe.style.bottom = '0px';
        }


        _this._resultsIframe.contentWindow.postMessage(
            {
                type: 'onScroll',
                frameTopOffset: _this._resultsIframe.getBoundingClientRect().top
            },
            '*'
        );
    });
};

OnLoadResultsLoad.prototype.processMessage = function(e) {
    if (e.data.type !== 'mbh') {
        return;
    }

    if (e.data.target !== null) {
        var target = null;

        switch (e.data.target) {
            case 'stepOneButton':
                target = this._stepOneButtonIframe;
                break;
            case 'stepOneParent':
                target = this._resultsIframe;
                break;
        }

        if (target !== null) {
            target.contentWindow.postMessage(e.data, '*');
        }

        return;
    }

    if (e.data.action === 'showStepOneButton') {
        this.toggleVisibleStepOneButton(true);

        return;
    }

    if (e.data.action === 'hideStepOneButton') {
        this.toggleVisibleStepOneButton(false);

        return;
    }

    if (e.data.action === 'resize') {
        this._resultsIframe = document.getElementById('mbh-results-iframe');
        if (this._resultsIframe === null) {
            return;
        }
        this._resultsIframe.style.height = e.data.data.height > 300 ? e.data.data.height + 'px' : '300px';

        return;
    }

    if (e.data.action === 'scrollToTopIframe') {
        this._resultsIframe = document.getElementById('mbh-results-iframe');
        if (this._resultsIframe === null) {
            return;
        }

        window.scrollTo(0, this._resultsIframe.offsetTop);
    }
};

OnLoadResultsLoad.prototype.toggleVisibleStepOneButton = function (isNeedShow) {
    if (isNeedShow) {
        this._stepOneButtonWrapper.style.display = 'block';
    } else {
        this._stepOneButtonWrapper.style.display = 'none';
    }
};

OnLoadResultsLoad.prototype.bridgeToStepOneButton = function (data) {
    if (this._stepOneButtonIframe === null) {
        return;
    }

    this._stepOneButtonIframe.contentWindow.postMessage({
        type: 'mbh',
        action: data.action,
        data: data.data
    })
};

OnLoadResultsLoad.prototype.exec = function() {
    if (window['mbhNewRbk'] !== undefined) {
        mbhNewRbk.init();
    }

    this._resultsWrapper = document.getElementById('mbh-results-wrapper');
    if (this._resultsWrapper === null) {
        return;
    }

    this.metrics();
    this.initUrl();
    this.createResultIframe();
    this.createButtonForStepOne();

    this._resultsWrapper.querySelector('a').style.display = 'none';

    var _this = this;

    window.addEventListener("message", function(ev) {
        _this.processMessage(ev)
    }, false);

    this.eventToScroll();
};

var onLoadResultsLoad = new OnLoadResultsLoad();

addLoadEvent(onLoadResultsLoad.exec());
{% endwrapinline %}
