services:
    mbh_search.search_combinations_generator:
        class: MBH\Bundle\SearchBundle\Services\SearchCombinationsGenerator
        arguments:
            - '@mbh_search.additional_days_generator'
            - '@mbh_search.data_holder'
            - '@mbh_search.data.hotel_in_search_determiner'

    mbh_search.query_group_creator:
        class: MBH\Bundle\SearchBundle\Services\QueryGroups\QueryGroupCreator

    mbh_search.search_conditions_roomtype_type:
        class: MBH\Bundle\SearchBundle\Form\RoomTypesType
        arguments:
            - '@mbh_search.client_config_repository'
            - '@mbh_search.hotel_repository'
            - '@mbh_search.room_category_to_room_type_transformer'
        tags:
            - { name: form.type, alias: MBH\Bundle\SearchBundle\Form\RoomTypesType }

    mbh_search.room_category_to_room_type_transformer:
        class: MBH\Bundle\SearchBundle\Form\DataTransformer\RoomCategoryToRoomTypeTransformer

    mbh_search.search_condition_creator:
        class: MBH\Bundle\SearchBundle\Services\SearchConditionsCreator
        arguments: ["@form.factory", '@mbh_search.search_config']


    mbh_search.additional_days_generator:
        class: MBH\Bundle\SearchBundle\Services\AdditionalDatesGenerator
        arguments:
            - '@mbh_search.search_config'


    # Restriction Block
    mbh_search.restrictions_checker_service:
        class: MBH\Bundle\SearchBundle\Services\RestrictionsCheckerService
        calls:
            - [addChecker, ['@mbh_search.restrictions.on_close']]
            - [addChecker, ['@mbh_search.restrictions.on_close_arrival']]
            - [addChecker, ['@mbh_search.restrictions.on_close_departure']]
            - [addChecker, ['@mbh_search.restrictions.on_max_before_arrival']]
            - [addChecker, ['@mbh_search.restrictions.on_max_guest']]
            - [addChecker, ['@mbh_search.restrictions.on_max_stay']]
            - [addChecker, ['@mbh_search.restrictions.on_max_stay_arrival']]
            - [addChecker, ['@mbh_search.restrictions.on_min_before_arrival']]
            - [addChecker, ['@mbh_search.restrictions.on_min_guest']]
            - [addChecker, ['@mbh_search.restrictions.on_min_stay']]
            - [addChecker, ['@mbh_search.restrictions.on_min_stay_arrival']]

        arguments: ['@mbh_search.data_manager']

    mbh_search.restrictions.on_close:
        public: false
        class: MBH\Bundle\SearchBundle\Lib\Restrictions\Closed

    mbh_search.restrictions.on_close_arrival:
        public: false
        class: MBH\Bundle\SearchBundle\Lib\Restrictions\ClosedOnArrival

    mbh_search.restrictions.on_close_departure:
        public: false
        class: MBH\Bundle\SearchBundle\Lib\Restrictions\ClosedOnDeparture

    mbh_search.restrictions.on_max_before_arrival:
        public: false
        class: MBH\Bundle\SearchBundle\Lib\Restrictions\MaxBeforeArrival

    mbh_search.restrictions.on_max_guest:
        public: false
        class: MBH\Bundle\SearchBundle\Lib\Restrictions\MaxGuest
        arguments:
            - '@mbh_search.occupancy_determiner'

    mbh_search.restrictions.on_max_stay:
        public: false
        class: MBH\Bundle\SearchBundle\Lib\Restrictions\MaxStay

    mbh_search.restrictions.on_max_stay_arrival:
        public: false
        class: MBH\Bundle\SearchBundle\Lib\Restrictions\MaxStayArrival

    mbh_search.restrictions.on_min_before_arrival:
        public: false
        class: MBH\Bundle\SearchBundle\Lib\Restrictions\MinBeforeArrival

    mbh_search.restrictions.on_min_guest:
        public: false
        class: MBH\Bundle\SearchBundle\Lib\Restrictions\MinGuest
        arguments:
            - '@mbh_search.occupancy_determiner'

    mbh_search.restrictions.on_min_stay:
        public: false
        class: MBH\Bundle\SearchBundle\Lib\Restrictions\MinStay

    mbh_search.restrictions.on_min_stay_arrival:
        public: false
        class: MBH\Bundle\SearchBundle\Lib\Restrictions\MinStayArrival


#search
    mbh_search.special_search:
      class: MBH\Bundle\SearchBundle\Services\Search\SpecialSearch
      arguments:
        - '@mbh_search.special_repository'
        - '@mbh.hotel.room_type_manager'
        - '@mbh_search.room_type_category_repository'

    mbh_search.async_searcher_grouped_by_room_type:
        class: MBH\Bundle\SearchBundle\Services\Search\AsyncSearchers\AsyncSearcherGroupedByRoomType
        arguments:
            - '@mbh_search.search_conditions_repository'
            - '@mbh_search.async_result_store'
            - '@mbh_search.searcher_factory'
            - '@mbh_search.room_type_search_decision_maker'
            - '@mbh_search.data_manager'

    mbh_search.room_type_search_decision_maker:
        class: MBH\Bundle\SearchBundle\Services\Search\AsyncSearchers\RoomTypeSearchDecisionMaker
        arguments: ['@snc_redis.cache_results_client', '@mbh_search.search_config_service']

    mbh_search.searcher_factory:
        class: MBH\Bundle\SearchBundle\Services\Search\SearcherFactory
        arguments:
            - '@mbh_search.searcher'
            - '@mbh_search.cache_searcher'


    #cache_searchers
    mbh_search.abstract_cache_searcher:
        class: MBH\Bundle\SearchBundle\Services\Search\AbstractCacheSearcher
        abstract: true
        arguments:
        - '@mbh_search.searcher'
        - '@mbh_search.cache_search'

    mbh_search.cache_searcher:
        class: MBH\Bundle\SearchBundle\Services\Search\CacheSearcher
        parent: 'mbh_search.abstract_cache_searcher'

    mbh_search.warm_up_cache_searcher:
        class: MBH\Bundle\SearchBundle\Services\Search\WarmUpCacheSearcher
        parent: 'mbh_search.abstract_cache_searcher'
        arguments:
            index_1: '@mbh_search.cache_warm_up_search'

    mbh_search.cache_key_creator:
        class: MBH\Bundle\SearchBundle\Services\Cache\CacheKeyCreator
        arguments:
            - '@event_dispatcher'
            - '@mbh_search.shared_data_fetcher'
            - '@mbh_search.cache_key_creator_factory'

    mbh_search.cache_key_creator_factory:
        class: MBH\Bundle\SearchBundle\Services\Cache\CacheKeyCreatorFactory
        arguments:
            - '@service_container'

    mbh_search.cache_key_abstract:
        abstract: true
        class: MBH\Bundle\SearchBundle\Lib\Combinations\CacheKey\AbstractKey
        arguments:
            - '@mbh_search.cache_key_determiner'

    mbh_search.cache_key_no_children_ages:
        class: MBH\Bundle\SearchBundle\Lib\Combinations\CacheKey\NoChildrenAgeCacheKey
        parent: mbh_search.cache_key_abstract

    mbh_search.cache_key_with_children_ages:
        class: MBH\Bundle\SearchBundle\Lib\Combinations\CacheKey\ChildFreeCacheKey
        parent: mbh_search.cache_key_abstract

    mbh_search.searcher:
        class: MBH\Bundle\SearchBundle\Services\Search\Searcher
        arguments:
            - '@mbh_search.restrictions_checker_service'
            - '@mbh_search.search_limit_checker'
            - '@mbh_search.search_result_creator'
            - '@validator'
            - '@mbh_search.price_searcher'
            - '@mbh_search.search_windows_checker'

    mbh_search.search:
        class: MBH\Bundle\SearchBundle\Services\Search\Search
        arguments:
            - '@mbh_search.restrictions_checker_service'
            - '@mbh_search.searcher_factory'
            - '@doctrine.odm.mongodb.document_manager'
            - '@mbh_search.search_condition_creator'
            - '@mbh_search.search_combinations_generator'
            - '@old_sound_rabbit_mq.async_search_producer'
            - '@mbh_search.results_answer_manager'
            - '@mbh_search.query_group_creator'
            - '@event_dispatcher'

    mbh_search.accommodation_room_searcher:
        class: MBH\Bundle\SearchBundle\Services\AccommodationRoomSearcher
        arguments:
            - '@mbh_search.data_manager'

    mbh_search.price_round_sign:
        class: stdClass
        factory: ['@mbh_search.client_config', getPriceRoundSign]

    mbh_search.calculation:
        class: MBH\Bundle\SearchBundle\Services\Calc\Calculation
        arguments:
            - '@mbh_search.price_caches_merger'
            - '@mbh_search.shared_data_fetcher'
            - '@mbh_search.calculation_helper'
            - '@mbh_search.price_round_sign'
            - '@mbh_search.special_repository'

    mbh_search.calculation_helper:
        class: MBH\Bundle\SearchBundle\Services\Calc\CalculationHelper
        arguments: ['@mbh.hotel.room_type_manager', '@mbh_search.shared_data_fetcher']

    mbh_search.price_caches_merger:
        class: MBH\Bundle\SearchBundle\Services\Calc\PriceCachesMerger
        arguments:
            - '@mbh_search.tariff_repository'
            - '@mbh_search.data_manager'
            - '@mbh_search.shared_data_fetcher'

    mbh_search.price_searcher:
        class: MBH\Bundle\SearchBundle\Services\Search\PriceSearcher
        arguments:
            - '@mbh_search.calculation'
            - '@mbh_search.occupancy_determiner'
            - '@event_dispatcher'
            - '@mbh.hotel.room_type_manager'
            - '@mbh_search.shared_data_fetcher'

#    mbh_search.result_composer:
#        class: MBH\Bundle\SearchBundle\Services\Search\SearchResultComposer
#        arguments:
#            - '@mbh_search.data_manager'
#            - '@mbh_search.shared_data_fetcher'
#            - '@mbh_search.accommodation_room_searcher'
#            - '@liip_imagine.templating.filter_helper'
#            - '@assets.packages'
#            - '@twig.extension.httpfoundation'
#            - '%online_booking%'

    mbh_search.search_result_creator:
      class: MBH\Bundle\SearchBundle\Services\Search\Result\SearchResultCreator
      arguments:
        ['@mbh.hotel.room_type_manager', '@mbh_search.shared_data_fetcher']

  # async receive results
    mbh_search.asycn_search:
        class: MBH\Bundle\SearchBundle\RabbitMQ\AsyncSearchConsumer
        calls:
            - [addSearcher, ['queryGroupByRoomType', '@mbh_search.async_searcher_grouped_by_room_type']]

    mbh_search.batch_asycn_search:
        class: MBH\Bundle\SearchBundle\RabbitMQ\AsyncSearchBatchConsumer
        arguments:
            - '@mbh_search.async_searcher_grouped_by_room_type'
            - '@mbh_search.consumer.logger'

    mbh_search.warm_up_search:
        class: MBH\Bundle\SearchBundle\RabbitMQ\WarmUpConsumer
        arguments:
            - '@mbh_search.warm_up_cache_searcher'
            - '@mbh_search.search_conditions_repository'
#            - '@mbh_search.garbage_collector'


    mbh_search.invalidate_consumer:
        class: MBH\Bundle\SearchBundle\RabbitMQ\InvalidateConsumer
        arguments:
            - '@mbh_search.search_cache_invalidator'

    #search limit checker for refactoring
    mbh_search.search_limit_checker:
        class: MBH\Bundle\SearchBundle\Services\Search\SearchLimitChecker
        arguments:
            - '@mbh_search.client_config_repository'
            - '@doctrine.odm.mongodb.document_manager'
            - '@mbh_search.shared_data_fetcher'
            - '@mbh_search.occupancy_determiner'
            - '@mbh_search.data_manager'

    mbh_search.search_windows_checker:
        class: MBH\Bundle\SearchBundle\Services\Search\WindowsChecker
        arguments:
          ['@mbh_search.client_config', '@mbh_search.shared_data_fetcher', '@doctrine.odm.mongodb.document_manager']

    #Occupancies
    mbh_search.occupancy_determiner:
        class: MBH\Bundle\SearchBundle\Services\Search\Determiners\Occupancies\OccupancyDeterminer
        arguments:
            - '@event_dispatcher'
            - '@mbh_search.occupancy_determiner_factory'
            - '@mbh_search.shared_data_fetcher'

    mbh_search.occupancy_determiner_common:
        class: MBH\Bundle\SearchBundle\Services\Search\Determiners\Occupancies\CommonOccupancyDeterminer

    mbh_search.occupancy_determiner_child_free_tariff:
        class: MBH\Bundle\SearchBundle\Services\Search\Determiners\Occupancies\ChildFreeOccupancyDeterminer

    mbh_search.occupancy_warm_up_determiner:
        class: MBH\Bundle\SearchBundle\Services\Search\Determiners\Occupancies\WarmUpOccupancyDeterminer

    mbh_search.occupancy_determiner_factory:
        class: MBH\Bundle\SearchBundle\Services\Search\Determiners\Occupancies\OccupancyDeterminerFactory
        arguments:
            - '@service_container'

    mbh_search.cache_key_determiner:
        class: MBH\Bundle\SearchBundle\Services\Search\Determiners\Occupancies\CacheKeyDeterminer
        arguments:
            - '@mbh_search.occupancy_determiner_factory'
            - '@mbh_search.shared_data_fetcher'


#invalidate Cache
    mbh_search.invalidate_adapter_factory:
        class: MBH\Bundle\SearchBundle\Lib\CacheInvalidate\InvalidateMessageFactory
        arguments:
        - '@mbh.hotel.room_type_manager'
        - '@doctrine.odm.mongodb.document_manager'

    mbh_search.search_cache_invalidator:
        class: MBH\Bundle\SearchBundle\Services\Cache\Invalidate\SearchCacheInvalidator
        arguments:
        - '@mbh_search.search_cache_item_repository'
        - '@snc_redis.cache_results_client'
        - '@mbh_search.invalidate_adapter_factory'
        - '@event_dispatcher'

    mbh_search.query_creator_factory:
        class: MBH\Bundle\SearchBundle\Services\Cache\InvalidateQueue\QueryCreatorFactory

    mbh_search.invalidate_queue_creator:
        class: MBH\Bundle\SearchBundle\Services\Cache\InvalidateQueue\InvalidateQueueCreator
        arguments:
            - '@old_sound_rabbit_mq.cache_invalidate_producer'
            - '@mbh_search.invalidate_adapter_factory'
            - '@mbh_search.query_creator_factory'

    # repositories
    mbh_search.hotel_repository:
      class: MBH\Bundle\HotelBundle\Document\HotelRepository
      factory: ["@doctrine.odm.mongodb.document_manager", getRepository]
      arguments:
      - MBH\Bundle\HotelBundle\Document\Hotel

    mbh_search.room_type_repository:
        class: MBH\Bundle\HotelBundle\Document\RoomTypeRepository
        factory: ["@doctrine.odm.mongodb.document_manager", getRepository]
        arguments:
            - MBH\Bundle\HotelBundle\Document\RoomType

    mbh_search.room_type_category_repository:
        class: MBH\Bundle\HotelBundle\Document\RoomTypeCategoryRepository
        factory: ["@doctrine.odm.mongodb.document_manager", getRepository]
        arguments:
            - MBH\Bundle\HotelBundle\Document\RoomTypeCategory

    mbh_search.room_cache_repository:
        class: MBH\Bundle\PriceBundle\Document\RoomCacheRepository
        factory: ["@doctrine.odm.mongodb.document_manager", getRepository]
        arguments:
            - MBH\Bundle\PriceBundle\Document\RoomCache

    mbh_search.price_cache_repository:
        class: MBH\Bundle\PriceBundle\Document\PriceCacheRepository
        factory: ["@doctrine.odm.mongodb.document_manager", getRepository]
        arguments:
            - MBH\Bundle\PriceBundle\Document\PriceCache

    mbh_search.tariff_repository:
        class: MBH\Bundle\PriceBundle\Document\TariffRepository
        factory: ["@doctrine.odm.mongodb.document_manager", getRepository]
        arguments:
            - MBH\Bundle\PriceBundle\Document\Tariff

    mbh_search.special_repository:
        class: MBH\Bundle\PriceBundle\Document\SpecialRepository
        factory: ["@doctrine.odm.mongodb.document_manager", getRepository]
        arguments:
            - MBH\Bundle\PriceBundle\Document\Special

    mbh_search.client_config_repository:
        class: MBH\Bundle\ClientBundle\Document\ClientConfigRepository
        factory: ["@doctrine.odm.mongodb.document_manager", getRepository]
        arguments:
            - MBH\Bundle\ClientBundle\Document\ClientConfig

    mbh_search.client_config:
        class: MBH\Bundle\ClientBundle\Document\ClientConfig
        factory: ["@mbh_search.client_config_repository", fetchConfig]

    mbh_search.restriction_repository:
        class: MBH\Bundle\PriceBundle\Document\RestrictionRepository
        factory: ["@doctrine.odm.mongodb.document_manager", getRepository]
        arguments:
            - MBH\Bundle\PriceBundle\Document\Restriction

    mbh_search.room_repository:
        class: MBH\Bundle\HotelBundle\Document\RoomRepository
        factory: ["@doctrine.odm.mongodb.document_manager", getRepository]
        arguments:
            - MBH\Bundle\HotelBundle\Document\Room

    mbh_search.package_repository:
        class: MBH\Bundle\PackageBundle\Document\PackageRepository
        factory: ["@doctrine.odm.mongodb.document_manager", getRepository]
        arguments:
            - MBH\Bundle\PackageBundle\Document\Package

    mbh_search.special_repository:
        class: MBH\Bundle\PriceBundle\Document\SpecialRepository
        factory: ["@doctrine.odm.mongodb.document_manager", getRepository]
        arguments:
            - MBH\Bundle\PriceBundle\Document\Special

    #Грязный хак. Т.к. с  основной веткой через черрипик, постоянно гемморой по поводу этого репозитория
    mbh_search.package_accommodation_repository:
      class: MBH\Bundle\PackageBundle\Document\PackageRepository
      factory: ["@doctrine.odm.mongodb.document_manager", getRepository]
      arguments:
        - MBH\Bundle\PackageBundle\Document\Package

    mbh_search.search_conditions_repository:
        class: MBH\Bundle\SearchBundle\Document\SearchConditionsRepository
        factory: ["@doctrine.odm.mongodb.document_manager", getRepository]
        arguments:
            - MBH\Bundle\SearchBundle\Document\SearchConditions

    mbh_search.search_result_holder_repository:
        class: MBH\Bundle\SearchBundle\Document\SearchResultHolderRepository
        factory: ["@doctrine.odm.mongodb.document_manager", getRepository]
        arguments:
            - MBH\Bundle\SearchBundle\Document\SearchResultHolder

    mbh_search.promotion_repository:
        class: MBH\Bundle\SearchBundle\Document\PromotionRepository
        factory: ["@doctrine.odm.mongodb.document_manager", getRepository]
        arguments:
            - MBH\Bundle\PriceBundle\Document\Promotion

    mbh_search.search_cache_item_repository:
      class: MBH\Bundle\SearchBundle\Document\SearchResultCacheItemRepository
      factory: ["@doctrine.odm.mongodb.document_manager", getRepository]
      arguments:
            - MBH\Bundle\SearchBundle\Document\SearchResultCacheItem

    mbh_search.search_search_config_repository:
        class: MBH\Bundle\SearchBundle\Document\SearchConfigRepository
        factory: ["@doctrine.odm.mongodb.document_manager", getRepository]
        arguments:
            - MBH\Bundle\SearchBundle\Document\SearchConfig
#
# Блок работы с данными
    mbh_search.data_holder:
        class: MBH\Bundle\SearchBundle\Lib\DataHolder
        arguments:
            - '@mbh_search.tariff_repository'
            - '@mbh_search.room_type_repository'
            - '@mbh_search.hotel_repository'

        deprecated: 'The "%service_id%" service is deprecated. Should be replaced by shared data fetcher'

##Holders
    mbh_search.room_cache_holder:
        class: MBH\Bundle\SearchBundle\Services\Data\RoomCacheHolder

    mbh_search.restrictions_holder:
        class: MBH\Bundle\SearchBundle\Services\Data\RestrictionsHolder

    mbh_search.room_holder:
        class: MBH\Bundle\SearchBundle\Services\Data\RoomHolder

    mbh_search.package_accommodation_holder:
        class: MBH\Bundle\SearchBundle\Services\Data\PackageAccommodationHolder
        arguments: ['@mbh_search.shared_data_fetcher']

    mbh_search.price_cache_holder:
        class: MBH\Bundle\SearchBundle\Services\Data\PriceCacheHolder
        arguments: ['@mbh_search.client_config_repository']

##Cache Results


    mbh_search.cache_search_abstract:
        class: MBH\Bundle\SearchBundle\Services\Cache\AbstractCacheSearchResult
        arguments:
            - '@mbh_search.search_cache_item_repository'
            - '@mbh_search.result_serializer'
            - '@snc_redis.cache_results_client'
            - '@mbh_search.cache_key_creator'
            - '@mbh_search.error_result_filter'
            - '@mbh_search.save_cache_logger'
            - '@mbh_search.search_result_creator'
        abstract: true

    mbh_search.cache_search:
        class: MBH\Bundle\SearchBundle\Services\Cache\CacheSearchResults
        parent: 'mbh_search.cache_search_abstract'

    mbh_search.cache_warm_up_search:
        class: MBH\Bundle\SearchBundle\Services\Cache\WarmUpCacheSearchResult
        parent: 'mbh_search.cache_search_abstract'

    mbh_search.cache_warmer:
        class: MBH\Bundle\SearchBundle\Services\Cache\CacheWarmer
        arguments:
            - '@mbh_search.search_condition_creator'
            - '@mbh_search.search_combinations_generator'
            - '@mbh_search.combinator'
            - '@mbh_search.tariff_repository'
            - '@mbh_search.cache_logger'
            - '@old_sound_rabbit_mq.warm_up_search_producer'
            - '@mbh_search.search_conditions_repository'


    ### Combinations
    mbh_search.combinator:
        class: MBH\Bundle\SearchBundle\Services\GuestCombinator
        arguments:
            - '@event_dispatcher'
            - '@mbh_search.combination_creator'

    mbh_search.combination_creator:
        class: MBH\Bundle\SearchBundle\Lib\Combinations\CombinationCreator
        arguments:
            - '@service_container'

    mbh_search.abstract_combinations:
        class: MBH\Bundle\SearchBundle\Lib\Combinations\AbstractCombinations
        abstract: true

    mbh_search.combinations.no_children_ages:
        class: MBH\Bundle\SearchBundle\Lib\Combinations\NoChildrenAgesCombination
        parent: 'mbh_search.abstract_combinations'

    mbh_search.combinations.with_children_ages:
        class: MBH\Bundle\SearchBundle\Lib\Combinations\ChildrenAgesCombination
        parent: 'mbh_search.abstract_combinations'

    ##REDIS_Caches
    #TODO: remove all redis?
#    mbh_search.redis:
#        class: Symfony\Component\Cache\Adapter\RedisAdapter
#        factory: ['Symfony\Component\Cache\Adapter\RedisAdapter', createConnection]
#        arguments: ['%mbh_redis%']

#    mbh_search.room_cache_redis_cache:
#        class: Symfony\Component\Cache\Simple\RedisCache
#        arguments:
#            - '@mbh_search.redis'
#            - 'room_caches'
#
#    mbh_search.restrictions_redis_cache:
#        class: Symfony\Component\Cache\Simple\RedisCache
#        arguments:
#            - '@mbh_search.redis'
#            - 'restrictions'
#
#    mbh_search.rooms_redis_cache:
#        class: Symfony\Component\Cache\Simple\RedisCache
#        arguments:
#            - '@mbh_search.redis'
#            - 'rooms'
#
#    mbh_search.package_accommodation_redis_cache:
#        class: Symfony\Component\Cache\Simple\RedisCache
#        arguments:
#            - '@mbh_search.redis'
#            - 'package_accommodations'
#
#    mbh_search.price_cache_redis_cache:
#        class: Symfony\Component\Cache\Simple\RedisCache
#        arguments:
#            - '@mbh_search.redis'
#            - 'price_caches'

#    mbh_search.search_result_redis_cache:
#        class: Symfony\Component\Cache\Simple\RedisCache
#        arguments:
#            - '@mbh_search.redis'
#            - 'search_results'
#
#    mbh_search.garbage_collector:
#        deprecated: 'The "%service_id%" service is deprecated. Remove IT!'
#        class: MBH\Bundle\SearchBundle\Services\GarbageCollector\GarbageCollector
#        calls:
#            - [addClient, ['@mbh_search.room_cache_redis_cache']]
#            - [addClient, ['@mbh_search.restrictions_redis_cache']]
#            - [addClient, ['@mbh_search.rooms_redis_cache']]
#            - [addClient, ['@mbh_search.package_accommodation_redis_cache']]
#            - [addClient, ['@mbh_search.price_cache_redis_cache']]
#            - [addClient, ['@mbh_search.search_result_redis_cache']]

    mbh_search.data.hotel_in_search_determiner:
        class: MBH\Bundle\SearchBundle\Services\Data\HotelInSearchDeterminer
        arguments:
            - '@mbh_search.hotel_repository'
            - '@mbh.hotel.selector'
            - '@mbh_search.shared_data_fetcher'

    mbh_search.info_service:
      class: MBH\Bundle\SearchBundle\Services\Data\InfoService
      arguments:
          - '@mbh_search.room_type_repository'
          - '@mbh_search.tariff_repository'
          - '@mbh_search.hotel_repository'
          - '@mbh_search.room_type_category_repository'
          - '@mbh_search.promotion_repository'
          - '%online_booking%'
          - '@twig.extension.httpfoundation'
          - '@assets.packages'
          - '@liip_imagine.templating.filter_helper'

    ##Fetchers
    mbh_search.shared_data_fetcher:
        class: MBH\Bundle\SearchBundle\Services\Data\SharedDataFetcher
        arguments:
            - '@mbh_search.tariff_repository'
            - '@mbh_search.room_type_repository'
            - '@mbh_search.room_repository'
            - '@mbh_search.hotel_repository'
            - '@mbh_search.room_type_category_repository'

#    mbh_search.room_cache_fetcher:
#        class: MBH\Bundle\SearchBundle\Services\Data\RoomCacheFetcher
#        arguments:
#            - '@mbh_search.room_cache_holder'
#            - '@mbh_search.shared_data_fetcher'
#            - '@mbh_search.room_cache_repository'
#            - '@mbh_search.room_cache_redis_cache'

#    mbh_search.restrictions_fetcher:
#        class: MBH\Bundle\SearchBundle\Services\Data\RestrictionsFetcher
#        arguments:
#            - '@mbh_search.restrictions_holder'
#            - '@mbh_search.shared_data_fetcher'
#            - '@mbh_search.restriction_repository'
#            - '@mbh_search.restrictions_redis_cache'

#    mbh_search.room_fetcher:
#        class: MBH\Bundle\SearchBundle\Services\Data\RoomFetcher
#        arguments:
#            - '@mbh_search.room_holder'
#            - '@mbh_search.shared_data_fetcher'
#            - '@mbh_search.room_repository'
#            - '@mbh_search.rooms_redis_cache'

#    mbh_search.package_accommodation_fetcher:
#        class: MBH\Bundle\SearchBundle\Services\Data\PackageAccommodationFetcher
#        arguments:
#            - '@mbh_search.package_accommodation_holder'
#            - '@mbh_search.shared_data_fetcher'
#            - '@mbh_search.package_accommodation_repository'
#            - '@mbh_search.package_accommodation_redis_cache'

#    mbh_search.price_cache_fetcher:
#        class: MBH\Bundle\SearchBundle\Services\Data\PriceCacheFetcher
#        arguments:
#            - '@mbh_search.price_cache_holder'
#            - '@mbh_search.shared_data_fetcher'
#            - '@mbh_search.price_cache_repository'
#            - '@mbh_search.client_config_repository'
#            - '@mbh_search.price_cache_redis_cache'

#Fetchers!
    mbh_search.data_manager:
        class: MBH\Bundle\SearchBundle\Services\Data\Fetcher\DataManager
        arguments:
            - '@snc_redis.clean_client'
        calls:
            - [addFetcher, ['@mbh_search.price_cache_fetcher']]
            - [addFetcher, ['@mbh_search.restrictions_fetcher']]
            - [addFetcher, ['@mbh_search.room_cache_fetcher']]
            - [addFetcher, ['@mbh_search.package_accommodation_fetcher']]
            - [addFetcher, ['@mbh_search.room_fetcher']]

#TODO: need factory to remove verbose service describe
    mbh_search.price_cache_fetcher:
        class: MBH\Bundle\SearchBundle\Services\Data\Fetcher\DataFetcher
        public: false
        arguments:
            - '@snc_redis.data_fetcher_client'
            - '@mbh_search.price_cache_raw_fetcher'
            - '@mbh_search.shared_data_fetcher'

    mbh_search.restrictions_fetcher:
        class: MBH\Bundle\SearchBundle\Services\Data\Fetcher\DataFetcher
        public: false
        arguments:
            - '@snc_redis.data_fetcher_client'
            - '@mbh_search.restriction_raw_fetcher'
            - '@mbh_search.shared_data_fetcher'

    mbh_search.room_cache_fetcher:
        class: MBH\Bundle\SearchBundle\Services\Data\Fetcher\DataFetcher
        public: false
        arguments:
            - '@snc_redis.data_fetcher_client'
            - '@mbh_search.room_cache_raw_fetcher'
            - '@mbh_search.shared_data_fetcher'

    mbh_search.room_fetcher:
        class: MBH\Bundle\SearchBundle\Services\Data\Fetcher\DataFetcher
        public: false
        arguments:
            - '@snc_redis.data_fetcher_client'
            - '@mbh_search.room_raw_fetcher'
            - '@mbh_search.shared_data_fetcher'

    mbh_search.package_accommodation_fetcher:
        class: MBH\Bundle\SearchBundle\Services\Data\Fetcher\DataFetcher
        public: false
        arguments:
            - '@snc_redis.data_fetcher_client'
            - '@mbh_search.package_accommodation_raw_fetcher'
            - '@mbh_search.shared_data_fetcher'

    mbh_search.price_cache_raw_fetcher:
        class: MBH\Bundle\SearchBundle\Services\Data\Fetcher\PriceCacheRawFetcher
        public: false
        arguments:
            - '@mbh.hotel.room_type_manager'
            - '@mbh_search.price_cache_repository'
            - '@mbh_search.actual_child_option_determiner'

    mbh_search.package_accommodation_raw_fetcher:
        class: MBH\Bundle\SearchBundle\Services\Data\Fetcher\PackageAccommodationRawFetcher
        public: false
        arguments:
          ['@mbh_search.package_accommodation_repository', '@mbh_search.shared_data_fetcher']

    mbh_search.restriction_raw_fetcher:
        class: MBH\Bundle\SearchBundle\Services\Data\Fetcher\RestrictionsRawFetcher
        public: false
        arguments:
            - '@mbh_search.restriction_repository'
            - '@mbh_search.actual_child_option_determiner'

    mbh_search.room_cache_raw_fetcher:
        class: MBH\Bundle\SearchBundle\Services\Data\Fetcher\RoomCacheRawFetcher
        public: false
        arguments:
          ['@mbh_search.room_cache_repository', '@mbh_search.actual_child_option_determiner']

    mbh_search.room_raw_fetcher:
        class: MBH\Bundle\SearchBundle\Services\Data\Fetcher\RoomRawFetcher
        public: false
        arguments:
          ['@mbh_search.room_repository']


    mbh_search.actual_child_option_determiner:
        class: MBH\Bundle\SearchBundle\Services\Data\ActualChildOptionDeterminer
        arguments: ['@mbh_search.shared_data_fetcher']


#SearchResult To JSON

    mbh_search.results_final_builder:
        public: false
        class: MBH\Bundle\SearchBundle\Services\FinalSearchResultsBuilder
        arguments:
            - '@mbh_search.result_serializer'
            - '@mbh_search.error_result_filter'

    mbh_search.results_answer_manager:
        class: MBH\Bundle\SearchBundle\Services\Search\FinalSearchResultsAnswerManager
        arguments:
            - '@mbh_search.results_final_builder'

#AsyncStores
    mbh_search.async_result_store:
        class: MBH\Bundle\SearchBundle\Services\Search\AsyncResultStores\AsyncResultStore
        arguments:
            - '@snc_redis.results_client'
            - '@mbh_search.result_serializer'
            - '@mbh_search.results_answer_manager'

#serializer
    mbh_search.serializer:
        class: Symfony\Component\Serializer\Serializer
        factory: ['MBH\Bundle\SearchBundle\Services\Data\Serializers\SearchSerializerFactory', createSerializer]

    mbh_search.normalizer:
        class: Symfony\Component\Serializer\Normalizer\ObjectNormalizer
        factory: ['MBH\Bundle\SearchBundle\Services\Data\Serializers\SearchSerializerFactory', createNormalizer]

    mbh_search.result_serializer:
      class: MBH\Bundle\SearchBundle\Services\Data\Serializers\ResultSerializer
      arguments:
            - '@mbh_search.serializer'
            - '@mbh_search.normalizer'

#loggers
    mbh_search.cache_logger_handler:
        class: Monolog\Handler\StreamHandler
        arguments: ["%kernel.logs_dir%/%kernel.environment%.cache.log", 200]
        public: false

    mbh_search.cache_logger:
        class: Monolog\Logger
        arguments: ['cache']
        calls:
            - [pushHandler, ['@mbh_search.cache_logger_handler']]

    mbh_search.save_cache_logger_handler:
        class: Monolog\Handler\StreamHandler
        arguments: ["%kernel.logs_dir%/%kernel.environment%.save.cache.log", 200]
        public: false

    mbh_search.save_cache_logger:
        class: Monolog\Logger
        arguments: ['save_cache']
        calls:
            - [pushHandler, ['@mbh_search.save_cache_logger_handler']]


    mbh_search.consumer_logger_handler:
        class: Monolog\Handler\StreamHandler
        arguments: ["%kernel.logs_dir%/%kernel.environment%.consumer.log", 100 ]
        public: false

    mbh_search.consumer.logger:
        class: Monolog\Logger
        arguments: ['data_fetch']
        calls:
            - [pushHandler, ['@mbh_search.consumer_logger_handler']]

    mbh_search.compare_logger_handler:
        class: Monolog\Handler\StreamHandler
        arguments: ["%kernel.logs_dir%/%kernel.environment%.search_compare.log", 200]
        public: false

    mbh_search.compare_logger:
        class: Monolog\Logger
        arguments: ['search_compare']
        calls:
        - [pushHandler, ['@mbh_search.compare_logger_handler']]

#data collector
#    mbh_search.cache_collector:
#        class: MBH\Bundle\SearchBundle\DataCollector\ResultCachedCollector
#        arguments:
#            - '@snc_redis.cache_results_client'
#            - '@mbh_search.search_cache_item_repository'
#        tags:
#            -
#                name: data_collector
#                template: 'MBHSearchBundle:DataCollector:template.html.twig'
#                id: 'search.cache.collector'

#subscribers
    mbh_search.combination.event.subscriber:
        class: MBH\Bundle\SearchBundle\EventSubscriber\GuestCombinatorSubscriber
        tags:
            - {name: kernel.event_subscriber, event: combination.childrenAges }

    mbh_search.invalidate.event.subscriber:
        arguments:
              - '@mbh_search.cache_warmer'
              - '@mbh_search.cache_key_creator'
        class: MBH\Bundle\SearchBundle\EventSubscriber\InvalidateEventSubscriber
        tags:
            - {name: kernel.event_subscriber, event: invalidator.key.invalidate }

    mbh_search.search.event.subscriber:
        arguments:
            - '@snc_redis.clean_client'
        class: MBH\Bundle\SearchBundle\EventSubscriber\SearchSubscriber
        tags:
            - {name: kernel.event_subscriber }

#compare command
    mbh_search.compare.command:
        class: MBH\Bundle\SearchBundle\Command\SearchCompareCommand
        arguments:
            - '@mbh_search.search'
            - '@mbh.package.search'
            - '@mbh_search.compare_logger'
            - '@doctrine_mongodb.odm.default_document_manager'
            - '@mbh.package.search_simple'
        tags:
            - { name: console.command }
#error result filter
    mbh_search.error_result_filter:
      class: MBH\Bundle\SearchBundle\Services\Cache\ErrorFilters\ErrorResultFilter

    mbh_search.debug_price_checker:
        class: MBH\Bundle\SearchBundle\Services\Search\Debug\DebugPriceChecker
        arguments:
            - '@mbh.package.search_simple'
            - '@mbh_search.tariff_repository'
            - '@mbh_search.slack_notifier'


    mbh_search.slack_notifier:
        class: MBH\Bundle\SearchBundle\Services\Search\Debug\SlackNotifier
        arguments:
            - '%slackToken%'
            - '%slackChannelId%'

    mbh_search.search_config_service:
        class: MBH\Bundle\SearchBundle\Services\SearchConfigService
        arguments: ['@mbh_search.search_search_config_repository']

    mbh_search.search_config:
        class: MBH\Bundle\SearchBundle\Document\SearchConfig
        factory: ["@mbh_search.search_config_service", getConfig]
